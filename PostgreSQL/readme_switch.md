# Переключение мастера на реплику
## Настройка потоковой репликации

Поскольку в нашей конфигурации не будет архива журнала предзаписи, важно на всех этапах использовать слот репликации — иначе при определенной задержке мастер может успеть удалить
необходимые сегменты и весь процесс придется повторять с самого начала.

Создаем слот:
```bash
SELECT pg_create_physical_replication_slot('replica');
```

Посмотрим на созданный слот:
```bash
SELECT * FROM pg_replication_slots \gx
```
Создадим автономную резервную копию, используя созданный слот. С ключом -R утилита создает файлы, необходимые для будущей реплики.
```bash
$ pg_basebackup --pgdata=/home/student/backup -R --slot=replica
```

Файл postgresql.auto.conf был подготовлен утилитой pg\_basebackup, поскольку мы указали ключ -R. Он содержит информацию для подключения к мастеру (primary_conninfo) и имя слота
репликации (primary\_slot_name):
```bash
student$ cat /home/student/backup/postgresql.auto.conf
```

```bash
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
primary_conninfo = 'user=student passfile=''/home/student/.pgpass'' channel_binding=prefer host=''/var/run/postgresql'' port=5432 sslmode=prefer sslcompression=0 sslsni=1 ssl_min_protocol_version=
primary_slot_name = 'replica'
```
Тут также должен быть параметр **host** с адресом мастера.

Утилита также создала сигнальный файл **standby.signal**, наличие которого указывает серверу войти в режим постоянного восстановления.

Выкладываем резервную копию в каталог данных сервера beta.
```bash
$ sudo pg_ctlcluster 13 beta status
Error: /var/lib/postgresql/13/beta is not accessible or does not exist
$ sudo rm -rf /var/lib/postgresql/13/beta
$ sudo mv /home/student/backup /var/lib/postgresql/13/beta
$ sudo chown -R postgres:postgres /var/lib/postgresql/13/beta
```

## Процессы реплики
Посмотрим на процессы реплики.
```bash
$ ps -o pid,command --ppid `sudo head -n 1 /var/lib/postgresql/13/beta/postmaster.pid`
```

```bash
PID COMMAND
55897 postgres: 13/beta: startup recovering 000000010000000000000005
55898 postgres: 13/beta: checkpointer
55899 postgres: 13/beta: background writer
55900 postgres: 13/beta: stats collector
55901 postgres: 13/beta: walreceiver streaming 0/5000060
```

Процесс **wal receiver** принимает поток журнальных записей, процесс **startup** применяет изменения.
Процессы **wal writer** и **autovacuum launcher** отсутствуют.

И сравним с процессами мастера.
```bash
$ ps -o pid,command --ppid `sudo head -n 1 /var/lib/postgresql/13/alpha/postmaster.pid`
PID COMMAND
55450 postgres: 13/alpha: checkpointer
55451 postgres: 13/alpha: background writer
55452 postgres: 13/alpha: walwriter
55453 postgres: 13/alpha: autovacuum launcher
55454 postgres: 13/alpha: stats collector
55455 postgres: 13/alpha: logical replication launcher
55490 postgres: 13/alpha: student student [local] idle
55902 postgres: 13/alpha: walsender student [local] streaming 0/5000060
```

Здесь добавился процесс **wal sender**, обслуживающий подключение по протоколу репликации.

## Переход на реплику

Сейчас сервер beta является репликой
```bash
β=> SELECT pg_is_in_recovery();
pg_is_in_recovery
-------------------
t
(1 row)
```

Повышаем реплику. В версии 13 появилась функция pg_promote(), которая выполняет то же действие.
```bash
$ sudo pg_ctlcluster 13 beta promote
```

Теперь бывшая реплика стала полноценным экземпляром.
```bash
β=> SELECT pg_is_in_recovery();
pg_is_in_recovery
-------------------
f
(1 row)
```

Мы можем изменять данные:
```bash
β=> INSERT INTO test VALUES ('Я - бывшая реплика (новый мастер).');
INSERT 0 1
```

## Возвращение старого мастера в строй
